define("alipay/common-v1/0.9.5/message",["gallery/jquery/1.7.2/jquery","arale/widget/0.9.16/templatable","gallery/handlebars/1.0.0/handlebars","arale/widget/0.9.16/ast-printer","arale/popup/0.9.6/dropdown","arale/popup/0.9.6/popup","arale/overlay/0.9.8/overlay","arale/position/0.9.2/position","arale/iframe-shim/0.9.3/iframe-shim","arale/widget/0.9.16/widget","arale/base/0.9.16/base","arale/class/0.9.2/class","arale/events/0.9.1/events","arale/base/0.9.16/aspect","arale/base/0.9.16/attribute","arale/widget/0.9.16/daparser","arale/widget/0.9.16/auto-render","alipay/common-v1/0.9.5/count"],function(e,t,n){function p(e){r.ajax(c.getmessage,{dataType:"jsonp"}).success(function(t){if(t.stat==="ok"){var n=parseInt(t.totalCount,10);a.setCount(n),e(t)}else a.hideCount()})}function d(e){return e.sort(function(e,t){return t.level-e.level})}function v(e){var t=0,n={infos:d(e.infos)},r=o.compile('{{#infos}}<li class="{{messageClass}} global-list-level{{level}}" data-id="{{id}}" data-level="{{level}}">{{{messageContent this}}}<a href="javascript:void(0);" class="global-list-close" seed="global-msg-close">X</a></li>{{/infos}}');return o.registerHelper("messageClass",function(){return t++>=3?"fn-hide":""}),o.registerHelper("messageContent",function(e){var t=e.url,n=e.content.length>46?e.content.replace(/^(.{43}).*$/,"$1..."):e.content;return/^(http|https)/i.test(t)?(t=c.redirecturl+"?msgId="+e.id+"&url="+t,'<a href="'+t+'" target="_blank" class="global-list-msg-content" seed="global-msg-item">'+n+"</a>"):'<span class="global-list-msg-content">'+n+"</span>"}),r(n)}function m(e){var t=this.$(".global-toplink-msgCount"),n=this.$("#global-list-msg"),i=n.children().length;t.html(i-1),a.setCount(i-1),i>3&&n.children(".fn-hide:first").removeClass("fn-hide"),r(e).parent().hide(400,"swing",function(){r(this).remove()})}var r=e("gallery/jquery/1.7.2/jquery"),i=e("arale/widget/0.9.16/templatable"),s=e("arale/popup/0.9.6/dropdown"),o=e("gallery/handlebars/1.0.0/handlebars"),u=e("arale/position/0.9.2/position"),a=e("alipay/common-v1/0.9.5/count"),f=window.GLOBAL||{},l=!1,c={redirecturl:f.system.personal+"/user/msgcenter/modifyStatusAndRedirect.htm",getmessage:f.system.personal+"/user/msgcenter/getMsgInfosNew.json?_callback=?",popmessage:f.system.personal+"/user/msgcenter/popMsgInfos.json?_callback=?",readmessage:f.system.personal+"/user/msgcenter/readMsg.json?_callback=?&historySource=I&msgIds="},h=s.extend({Implements:i,Statics:{getMessageCount:p},events:{"click #global-msg-isee":"markAllRead","click #global-list-msg a.global-list-msg-content":function(e){m.call(this,e.currentTarget)},"click #global-list-msg a.global-list-close":"markRead","click #global-msg-confirm-ok":"confirmOk","click #global-msg-confirm-cancel":"confirmCancel","mouseenter .global-list li":function(e){r(e.currentTarget).addClass("global-list-hover")},"mouseleave .global-list li":function(e){r(e.currentTarget).removeClass("global-list-hover")}},show:function(){var e=this;return l||r.ajax(c.popmessage,{dataType:"jsonp"}).success(function(t){if(t.stat!=="ok")return;a.setCount(t.totalCount),e.renderMsg(t)}),a.getCount()>0?h.superclass.show.call(this):this},renderMsg:function(e){return l||(this.$(".global-toplink-msgCount").html(e.totalCount),this.$("#global-list-msg").html(v(e)).removeClass("global-loading"),l=!0),this},markAllRead:function(e){e.preventDefault(),a.setCount(0);var t=this.$("#global-list-msg li").map(function(){return r(this).attr("data-id")}).get().join(",");this.hide(),this.$("#global-list-msg").html(),r.ajax(c.readmessage+t,{dataType:"jsonp"})},markRead:function(e){var t=e.currentTarget,n=r(t).parent(),i=this.$("#global-msg-confirm"),s=n.attr("data-id");this.currentConfirmMsg&&(r(this.currentConfirmMsg).parent().css("height","auto"),this.currentConfirmMsg=null),n.attr("data-level")==3?(this.currentConfirmMsg=t,n.css("height",i.height()-16),i.show(),u.pin(i[0],n[0])):(i.hide(),m.call(this,t),r.ajax(c.readmessage+s,{dataType:"jsonp"}))},confirmOk:function(e){e.preventDefault();var t=r(this.currentConfirmMsg).parent().attr("data-id");this.$("#global-msg-confirm").hide(),m.call(this,this.currentConfirmMsg),r.ajax(c.readmessage+t,{dataType:"jsonp"})},confirmCancel:function(e){e.preventDefault(),r(this.currentConfirmMsg).parent().css("height","auto"),this.currentConfirmMsg=null,this.$("#global-msg-confirm").hide()}});n.exports=h});
